<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>melcoffee â€” Coffee Recommender</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>body{font-family:system-ui,Arial;margin:20px} label{display:block;margin:8px 0}</style>
</head>
<body>
  <h1>Find a coffee for you</h1>
  <form id="qform">
    <label>Milk preference:
      <select name="milk">
        <option value="">No preference</option>
        <option value="light">Light (long black / americano)</option>
        <option value="normal">Normal</option>
        <option value="rich">Rich (flat white / latte)</option>
      </select>
    </label>
    <label>Strength:
      <select name="strength">
        <option value="">No preference</option>
        <option value="mild">Mild</option>
        <option value="regular">Regular</option>
        <option value="strong">Strong</option>
      </select>
    </label>
    <label>Price:
      <select name="price">
        <option value="">No preference</option>
        <option value="cheap">Budget</option>
        <option value="mid">Mid</option>
        <option value="expensive">Premium</option>
      </select>
    </label>
    <label>Hot or Iced:
      <select name="iced">
        <option value="">Either</option>
        <option value="true">Iced</option>
        <option value="false">Hot</option>
      </select>
    </label>
    <label>Vibe:
      <select name="vibe">
        <option value="">Any</option>
        <option value="quiet">Quiet</option>
        <option value="trendy">Trendy</option>
        <option value="cozy">Cozy</option>
      </select>
    </label>
    <button type="submit">Recommend</button>
  </form>
  <hr>
  <div id="results"></div>

  <script src="inline_data.js"></script>
  <script>
    (function(){
      const dbg = document.createElement('pre'); dbg.id='debuglog'; dbg.style.position='fixed'; dbg.style.left='10px'; dbg.style.right='10px'; dbg.style.bottom='10px'; dbg.style.maxHeight='40vh'; dbg.style.overflow='auto'; dbg.style.background='rgba(0,0,0,0.7)'; dbg.style.color='#fff'; dbg.style.padding='8px'; dbg.style.fontSize='12px'; dbg.style.display='none'; document.body.appendChild(dbg);
      function log(m){ dbg.style.display='block'; dbg.textContent += m+'\n'; }
      window.DEVLOG = log;
      window.addEventListener('error', e=>{ log('ERROR: '+(e && e.message)); });
      window.addEventListener('unhandledrejection', e=>{ log('PROMISE REJECTION: '+(e && e.reason)); });
    })();
    document.getElementById('qform').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const fd = new FormData(e.target);
      const body = { milk: fd.get('milk') || undefined, strength: fd.get('strength') || undefined, price: fd.get('price') || undefined, iced: fd.get('iced')===''?undefined:(fd.get('iced')==='true'), vibe: fd.get('vibe') || undefined };
      let data = [];
      try{
        const res = await fetch('/api/recommend', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
        if(res.ok) data = await res.json();
      }catch(e){}
      // fallback: inline data or local scoring
      let items = [];
      if((!data || data.length===0) && window.INIT_COFFEE) items = window.INIT_COFFEE;
      if(!items || items.length===0){
        const r2 = await fetch('data/coffee.json');
        if(r2.ok) items = await r2.json();
      }
        // simple client-side scoring similar to server
        function scoreItem(item){ let score=0; const tags=(item.tags||[]).map(t=>t.toLowerCase()); if(body.milk){ if(body.milk==='rich' && tags.includes('flat white')) score+=2; if(body.milk==='light' && tags.includes('long black')) score+=2; } if(body.strength){ if(body.strength==='strong' && tags.includes('strong')) score+=2; if(body.strength==='mild' && tags.includes('smooth')) score+=2; } if(body.price){ if(body.price==='cheap' && tags.includes('affordable')) score+=1; if(body.price==='expensive' && tags.includes('premium')) score+=1; } if(typeof body.iced==='boolean'){ if(body.iced && tags.includes('iced')) score+=1; if(!body.iced && tags.includes('hot')) score+=1; } if(body.vibe){ if(tags.includes(body.vibe)) score+=1; } if(item.popularity) score += Math.min(2, item.popularity/50); return score; }
        const scored = items.map(i=>({item:i, score: scoreItem(i)})); scored.sort((a,b)=>b.score-a.score); data = scored.slice(0,8).map(s=>({score:s.score, item:s.item}));
      }
      const div = document.getElementById('results'); div.innerHTML='';
      if(!data.length) return div.textContent='No recommendations (add more places in admin).';
      data.forEach(entry=>{
        const it = entry.item;
        const card = document.createElement('div'); card.style.border='1px solid #ddd'; card.style.padding='8px'; card.style.margin='8px 0';
        const img = document.createElement('img');
        try{ if((it.image||'').startsWith('data:')) img.src = it.image; else img.src = (it.image || '') + (it.image && it.image.indexOf('?')>-1? '&v=' : '?v=') + Date.now(); }catch(e){ img.src = it.image||''; }
        img.style.maxWidth='120px'; img.style.float='left'; img.style.marginRight='12px'; img.alt = it.name || '';
        img.loading = 'lazy'; img.style.background='#fafafa';
        (function(idx,imgEl){ const fallback='https://eddiee-shin.github.io/melcoffee/images/img'+((idx%6)+1)+'.png'; imgEl.onerror=function(){ if(this.src===fallback) return; try{ this.src=fallback + (fallback.indexOf('?')>-1? '&v=' : '?v=') + Date.now(); }catch(e){} }; })(index, img);
        const title = document.createElement('div'); title.innerHTML = `<b>${it.name}</b> (${it.location||''})`;
        const tags = document.createElement('div'); tags.textContent = (it.tags||[]).join(', ');
        const score = document.createElement('div'); score.textContent = 'Score: '+entry.score;
        card.appendChild(img); card.appendChild(title); card.appendChild(tags); card.appendChild(score);
        div.appendChild(card);
      });
    });
  </script>
</body>
</html>