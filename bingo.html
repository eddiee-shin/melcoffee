<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>melcoffee — Coffee Bingo</title>
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <style>
    body{font-family:system-ui,Arial;margin:20px}
    .controls{margin-bottom:12px}
    .bingo{display:grid;grid-template-columns:repeat(5,1fr);gap:8px;max-width:900px;margin:0 auto}
    .cell{border:2px solid #333;height:140px;display:flex;flex-direction:column;align-items:center;justify-content:center;padding:6px;background:#fff}
    .cell img{max-width:100%;max-height:70px;object-fit:cover;border-radius:6px}
    .cell .name{font-size:14px;margin-top:6px;text-align:center}
    .cell.visited{background:#dff0d8}
    .center{font-weight:bold;font-size:20px}
    #seed{width:200px}
    .btn{padding:8px 12px;margin-right:8px}
  </style>
</head>
<body>
  <h1>melcoffee — Random Coffee Bingo</h1>
  <div class="controls">
    <button id="new" class="btn">New Bingo</button>
    Seed: <input id="seed" placeholder="optional seed" />
    <button id="print" class="btn">Print / Save PDF</button>
    <button id="download" class="btn">Download PNG</button>
  </div>
  <div id="bingo" class="bingo"></div>

  <script src="/inline_data.js"></script>
  <script>
    function rng(seed) {
      // simple mulberry32
      let h = 2166136261 >>> 0;
      for (let i=0;i<seed.length;i++) h = Math.imul(h ^ seed.charCodeAt(i), 16777619);
      return function() {
        h += 0x6D2B79F5;
        var t = Math.imul(h ^ h >>> 15, 1 | h);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    async function loadAndRender(seedStr){
      let items = [];
      try{ const res = await fetch('/api/coffee'); if(res.ok) items = await res.json(); }catch(e){}
      if((!items || items.length===0) && window.INIT_COFFEE) items = window.INIT_COFFEE;
      if(!items || items.length===0){ try{ const r2 = await fetch('/data/coffee.json'); if(r2.ok) items = await r2.json(); }catch(e){} }
      if(!items || !items.length){ document.getElementById('bingo').innerHTML = '<p>No items yet. Add via /admin</p>'; return; }
      const seed = seedStr || (Math.random().toString(36).slice(2,8));
      const r = rng(seed);
      // shuffle
      const arr = items.slice();
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(r()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      // pick 25 (or repeat if less)
      const cells = [];
      for(let i=0;i<25;i++) cells.push(arr[i % arr.length]);

      const container = document.getElementById('bingo');
      container.innerHTML = '';
      for(let i=0;i<25;i++){
        const cell = document.createElement('div'); cell.className='cell';
        if(i===12){ // center
          cell.classList.add('center');
          cell.innerHTML = '<div>FREE</div>';
        } else {
          const it = cells[i];
          const img = document.createElement('img');
          img.src = it.image || '';
          const name = document.createElement('div'); name.className='name'; name.textContent = it.name || '';
          cell.appendChild(img); cell.appendChild(name);
        }
        cell.onclick = ()=>{ cell.classList.toggle('visited'); };
        container.appendChild(cell);
      }
      document.getElementById('seed').value = seed;
    }

    document.getElementById('new').addEventListener('click', ()=>{ loadAndRender(document.getElementById('seed').value); });
    document.getElementById('print').addEventListener('click', ()=>{ window.print(); });
    document.getElementById('download').addEventListener('click', async ()=>{
      // render bingo div to canvas using html2canvas if available
      if(!window.html2canvas){ alert('PNG download requires html2canvas. Open admin to add script or use print.'); return; }
      const el = document.getElementById('bingo');
      const canvas = await html2canvas(el, {backgroundColor:'#ffffff'});
      const data = canvas.toDataURL('image/png');
      const a = document.createElement('a'); a.href = data; a.download = 'melcoffee_bingo.png'; a.click();
    });

    // try load on start
    loadAndRender('');
  </script>
  <!-- optional html2canvas for PNG download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
</body>
</html>